name: Apigee Proxy Deployment
on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'apiproxy/**'
  workflow_dispatch:
    inputs:
      proxy_name:
        description: "The name of the API proxy to deploy"
        required: true
        default: "DefaultProxyName"
      environment_group:
        description: "Select environment group"
        required: true
        type: choice
        options:
          - "default"
          - "edd"
          - "homerun"
          - "wow"
          - "wpay"
      environment_type:
        description: "Select environment type(s)"
        required: true
        type: choice
        options:
          - "dev"
          - "test"
          - "uat"
          - "dev,test"
          - "test,uat"
          - "dev,test,uat"
      proxy_directory:
        description: "Directory containing the API proxy files"
        required: false
        default: "apiproxy"

permissions:
  id-token: write
  contents: read

jobs:
  verify_auth:
    runs-on: ubuntu-latest
    steps:
      - name: Debug Identity Information
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Organization: ${{ github.repository_owner }}"
          
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}
          create_credentials_file: true
          token_format: 'access_token'

  deploy:
    needs: verify_auth
    uses: atlaspendo/apigeex-cicd/.github/workflows/Reusable-proxy-deploy.yml@main
    with:
      proxy_name: ${{ github.event.inputs.proxy_name || github.event.repository.name }}
      environment_group: ${{ github.event.inputs.environment_group }}
      environment_type: ${{ github.event.inputs.environment_type }}
      proxy_directory: ${{ github.event.inputs.proxy_directory || 'apiproxy' }}
      runner: 'ubuntu-latest'
    secrets:
      apigee_org: ${{ secrets.APIGEE_ORG }}
      workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      service_account: ${{ secrets.SERVICE_ACCOUNT }}
